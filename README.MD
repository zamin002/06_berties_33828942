# Berties Books – Dynamic Web Applications Lab 6  
**Student ID:** 33828942

This project is the completed implementation of the Berties Books web application for Lab 6.  
It is a Node.js + Express web app connected to a MySQL database, using EJS templates for rendering and deployed on a Goldsmiths VM.

---

## 1. How to Install and Run (Local Machine)

### Clone the repository

git clone https://github.com/zamin002/06_berties_33828942


cd 06_berties_33828942


### Install dependencies

npm install


### Set up the local MySQL database
Start MySQL, then run:

source create_db.sql;
source insert_test_data.sql;


### Run the application locally

npm start


The app will be available at:

http://localhost:8000


---

## 2. Deployment on the Goldsmiths VM

### SSH into your VM

ssh <your-username>@doc.gold.ac.uk


### Clone the repo and install modules

git clone https://github.com/zamin002/06_berties_33828942


cd 06_berties_33828942
npm install


### Set up the database on the VM
Open MySQL:

sudo mysql

Run:

source create_db.sql;
source insert_test_data.sql;


### Run the app using **forever**

forever start main.js


The live app will be available at:  

http://www.doc.gold.ac.uk/usr/33828942/

---

## 3. App Features

- View all books  
- Add a new book  
- List bargain books (price < £20)  
- Search books (exact + partial match using LIKE)  
- Displays results via EJS templates  
- Works locally and on the VM  

---

## 4. Routes Summary

| Route | Description |
|-------|-------------|
| `/books/list` | View all books |
| `/books/addbook` | Add book form |
| `/books/bookadded` | Insert new book |
| `/books/bargainbooks` | Books under £20 |
| `/books/search` | Search form |
| `/books/search_result` | Search results |

---

## 5. Technologies Used

- Node.js  
- Express.js  
- MySQL  
- mysql2  
- EJS  
- CSS  
- Forever  

---
## 6. dotenv

I used the dotenv package to remove hard-coded database credentials from the code.
I created a .env file that stores DB_HOST, DB_USER, DB_PASSWORD, and DB_DATABASE.
In my index.js I called require('dotenv').config() and changed the MySQL pool to use process.env variables.
This improves security and makes deployment easier.
---
## 7. audit

I implemented login auditing so that every login attempt (successful or failed) is recorded.

I created a table called login_audit:

CREATE TABLE login_audit (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(100),
  success TINYINT(1) NOT NULL,
  ip_address VARCHAR(45),
  timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
);


Inside the /users/loggedin route, every login attempt inserts a row into this table:

attempted username

whether the password matched (success = 1 or 0)

user’s IP address (req.ip)

timestamp (auto-generated by MySQL)

I added a route /users/audit which queries the table and displays the results using audit.ejs.

This provides a simple audit trail showing when users log in and whether the attempt was successful.
---
## 8. Access Control
I used a redirectLogin middleware to protect certain routes.

Public routes: home, about, viewing and searching books.

Protected routes:

/users/list – shows personal data of registered users.

/users/audit – shows login attempts and IP addresses.

/books/addbook  – changes the inventory and is restricted to logged-in users only.

The user must log in successfully (which sets req.session.userId) to access these routes, otherwise they are redirected to the login page.
---
## 9. Validation
I added validation to every route where user input could affect the database or be rendered back into a page:

1. Registration page (POST /registered)

Validated fields:

email -> must be a valid email (isEmail())

username -> must be 5–20 characters (isLength({min:5,max:20}))

password -> must be at least 8 characters (isLength({min:8}))

first -> must not be empty

last -> must not be empty

I did it since these fields create a user account, so preventing invalid/weak data protects the database and improves data integrity.

2. Add Book page (POST /bookadded)

Validated fields:

name -> must not be empty

price -> must be a number (isFloat({min:0}))

I did it since this route modifies the books database. Empty names or non-numeric prices could break the data or cause incorrect listings.

3. Login page (POST /loggedin)

Validated fields:

username -> must not be empty

password -> must not be empty

I did it to prevent pointless database lookups and improve security by ensuring the login form is not submitted with blank input.

4. Search function (GET /search_result)

Validated fields:

search_text -> must not be empty

I did it to stop users from performing empty searches, and ensure that the search page behaves correctly.

What I did NOT validate (and why)
1. Password content

I did not validate characters inside the password (e.g., symbols or patterns).
Reason: The lab requires only a minimum length, and adding extra password rules wasn’t necessary.

2. Numeric fields that don’t require validation

Only price needed numeric validation.
Other numeric database IDs are never entered manually by the user.

3. Fields not submitted by the user

I did not validate:

session values

automatically generated timestamps

database IDs

Reason: These are system-controlled, not user input.

4. GET routes that do not receive input

Example:

GET /register

GET /login

GET /addbook

Reason: GET routes simply display the page and contain no user-submitted data.
---
## 10. Sanitization

I sanitised all user-submitted text fields that may appear in rendered HTML, such as first name, last name, email, username, and search queries.

I did not sanitise passwords or numeric fields because sanitisation could modify the values and break either password hashing or numeric processing.
---
## 11. API

**Endpoint:** `GET /api/books`

Returns a JSON list of books.

**Query parameters (optional):**

- `search` – filter by book name (substring match)
- `minprice` and `maxprice` – filter by price range
- `sort` – `name` or `price`

**Examples:**

- `/api/books`
- `/api/books?search=world`
- `/api/books?minprice=5&maxprice=10`
- `/api/books?sort=price`
